<?xml version="1.0" encoding="ISO-8859-1"?>
<project name="coffee-brew" default="install-rubymine">

    <!-- Define build properties -->

    <loadfile property="version" srcfile="VERSION">
        <filterchain>
            <striplinebreaks/>
        </filterchain>
    </loadfile>

    <property file="build.properties"/>
    <property name="idea.codename" value="maia"/>
              
    <!-- Reference the IDEA classpath from the local IDE installation -->

    <path id="idea.classpath">
        <fileset dir="${idea.home}">
            <include name="lib/*.jar"/>
            <include name="redist/*.jar"/>
        </fileset>
        <fileset dir="/Applications/IntelliJ IDEA 10 CE.app/lib/">
            <include name="*.jar"/>
        </fileset>
    </path>

    <!-- Define the java compiler task -->

    <taskdef name="javac2" classname="com.intellij.ant.Javac2">
        <classpath refid="idea.classpath"/>
    </taskdef>

    <!-- Define the jflex compiler task -->

    <taskdef name="jflex" classname="JFlex.anttask.JFlexTask">
        <classpath location="${idea.home}/tools/lexer/jflex-1.4/lib/JFlex.jar"/>
    </taskdef>

    <!-- Clean up generated files -->

    <target name="clean">
        <delete dir="target"/>
    </target>

    <!-- Create target directories -->

    <target name="init" depends="clean">
        <mkdir dir="target/classes/META-INF"/>
        <mkdir dir="target/junit"/>
        <mkdir dir="target/test-classes"/>
        <mkdir dir="target/test-reports"/>
        <mkdir dir="target/coffee-script"/>
        <mkdir dir="target/jar"/>
    </target>

    <!-- Copy compilation resources -->

    <target name="resources" depends="init">
        <copy todir="target/classes">
            <fileset dir="resources" excludes="coffee-script/**"/>
        </copy>
    </target>

    <!-- Generate the tokens from the CoffeeScript resources for testing the plugin -->

    <target name="generate-original-tokens" depends="init"
            description="Generate the CoffeeScript tokens within resources/coffee-script">
        <apply executable="/usr/local/bin/node">
            <arg value="/usr/local/share/npm/bin/coffee"/>
            <arg value="-t"/>
            <fileset dir="resources/coffee-script" includes="*.coffee"/>
            <redirector>
                <outputmapper type="glob" from="*.coffee" to="resources/coffee-script/*.tokens"/>
            </redirector>
        </apply>
    </target>

    <!-- Generate the lexer class -->

    <target name="generate-lexer" description="Generate the CoffeeScriptLexer class from the flex definition">
        <jflex skeleton="${idea.home}/tools/lexer/idea-flex.skeleton" nobak="true"
               file="src/org/coffeebrew/lang/lexer/coffee-script.flex"
               destdir="src"
               charat="true"/>
    </target>

    <!-- Compile the plugin -->

    <target name="compile" depends="resources, generate-lexer">
        <javac2 srcdir="src" destdir="target/classes" source="1.5" target="1.5" includeantruntime="yes">
            <classpath refid="idea.classpath"/>
        </javac2>
        <javac2 srcdir="test" destdir="target/test-classes" source="1.5" target="1.5" includeantruntime="yes">
            <classpath refid="idea.classpath"/>
            <classpath location="target/classes"/>
        </javac2>
    </target>

    <!-- Test the plugin -->

    <target name="test" depends="compile">
        <junit failureproperty="unit-test.fail" forkmode="once" fork="yes" includeantruntime="yes"
               tempdir="${basedir}/target/junit" printsummary="yes" showoutput="yes">
            <classpath location="${basedir}/target/classes"/>
            <classpath location="${basedir}/target/test-classes"/>
            <classpath refid="idea.classpath"/>
            <formatter type="xml"/>
            <batchtest todir="${basedir}/target/test-reports" fork="yes">
                <fileset dir="${basedir}/target/test-classes" includes="**/*Test.class"/>
            </batchtest>
        </junit>
        <fail if="unit-test.fail" message="Unit test failed. See target/test-reports for more information."/>
    </target>

    <!-- Build the jar -->

    <target name="jar" depends="test, compile" description="Build the plugin jar">
        <copy file="META-INF/plugin.xml" todir="target/classes/META-INF">
            <filterset>
                <filter token="version" value="${version}"/>
            </filterset>
        </copy>
        <jar destfile="target/jar/coffee-brew-${version}-${idea.codename}.jar" compress="true">
            <fileset dir="target/classes"/>
        </jar>
    </target>

    <!-- Install plugin to IntelliJ IDEA 9.0.3 CE -->

    <target name="install-idea" depends="jar" description="Install the plugin to IntelliJ IDEA 9.0.3 CE">
        <mkdir dir="${user.home}/Library/Application Support/IntelliJIdea90CE"/>
        <delete dir="${user.home}/Library/Application Support/IntelliJIdea90CE" includes="coffee-brew*.jar"/>
        <copy todir="${user.home}/Library/Application Support/IntelliJIdea90CE">
            <fileset dir="${basedir}/target/jar" includes="*.jar"/>
        </copy>
    </target>

    <!-- Install plugin to RubyMine 3 -->

    <target name="install-rubymine" depends="jar" description="Install the plugin to RubyMine 3">
        <mkdir dir="${user.home}/Library/Application Support/RubyMine30"/>
        <delete dir="${user.home}/Library/Application Support/RubyMine30" includes="coffee-brew*.jar"/>
        <copy todir="${user.home}/Library/Application Support/RubyMine30">
            <fileset dir="${basedir}/target/jar" includes="*.jar"/>
        </copy>
    </target>

</project>
